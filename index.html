<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corny Stories</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fefefe;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #6c63ff;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 2px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    nav {
      display: flex;
      background: #f0f0f5;
      border-bottom: 1px solid #ddd;
      justify-content: center;
    }
    nav button {
      background: none;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    nav button:hover, nav button.active {
      background-color: #6c63ff;
      color: white;
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    h1.story-title {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: #6c63ff;
    }
    .story-content {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 1.1rem;
      background: #fafafa;
      border-left: 5px solid #6c63ff;
      padding: 1rem 1.5rem;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      margin-bottom: 1rem;
    }
    .author {
      font-weight: 600;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.7rem;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    label {
      font-weight: 600;
      font-size: 1.1rem;
    }
    input[type="text"], textarea {
      padding: 0.75rem;
      font-size: 1rem;
      border: 1.5px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      min-height: 120px;
    }
    textarea {
      min-height: 150px;
    }
    button.submit-btn {
      max-width: 150px;
      padding: 0.7rem 1rem;
      background-color: #6c63ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
    }
    button.submit-btn:hover {
      background-color: #5548c8;
    }
    .stories-list {
      margin-top: 2rem;
    }
    .story-item {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.05);
      position: relative;
    }
    .story-item h3 {
      margin: 0 0 0.5rem 0;
      color: #6c63ff;
    }
    .delete-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #ff4d4d;
      border: none;
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.85rem;
    }
    .delete-btn:hover {
      background: #cc0000;
    }
    .audio-btn {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background-color: #6c63ff;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    .audio-btn:hover {
      background-color: #5548c8;
    }
    footer {
      text-align: center;
      padding: 1rem;
      margin-top: 3rem;
      border-top: 1px solid #ddd;
      color: #777;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>Corny Stories</header>
  <nav>
    <button id="btnStory" class="active">Three's a Fever + User Stories</button>
    <button id="btnAddStory">Add More Stories</button>
  </nav>

  <main>
    <!-- Story content container -->
    <section id="storySection">
      <h1 class="story-title">Three's a Fever</h1>
      <div id="defaultStory" class="story-content">
        <div class="author">Authors: Addisyn Holley, Jordan Schaller, and Donovan Schaller</div>
        The music pulsed low through the dim living room, amber lights painting soft shadows on the walls. Sophia sat curled into the corner of the couch, legs crossed, wine glass in hand. Her gaze flicked between the two across the room — Gauge, effortlessly cool, leaning against the doorframe, and Justin, sprawled across the armchair like he owned the place.

        None of them said much, but the energy was thick. Tangible.

        Gauge caught her glance and smirked. “You’re awfully quiet, Sophia.”

        She tilted her head slightly, lips curling. “Just enjoying the view.”

        Justin let out a low laugh. “You mean me or him?”

        “Both,” she said, without hesitation.

        That earned a glance between the two men — a silent exchange that said more than words ever could. Gauge finally moved from the wall, walking over to the couch with slow, confident steps. He sat beside her, close enough that his leg brushed against hers, just barely.

        Sophia didn’t move away.

        Justin stayed still at first, watching them like a storm building. Then he rose, slow and deliberate, circling around the back of the couch. His fingers brushed the side of her neck — a featherlight touch that made her eyes flutter shut for just a second.

        The tension crackled.

        “You know,” Gauge murmured near her ear, “we’ve both noticed the way you look at us.”

        Sophia turned slightly, heartbeat climbing. “And what if I’ve noticed the way you look at me?”

        Justin leaned down, voice smooth. “Then maybe it’s time we stop dancing around it.”

        Gauge’s hand slipped to the small of her back. Justin’s breath was warm against her neck. The air between them tightened, thick with heat, and for a moment — just a breathless moment — no one moved.

        Three hearts, one spark.

        And the night had only just begun.

        <!-- You can keep the full story content here or link to a separate file if you want -->
      </div>

      <div id="userStoriesContainer" style="margin-top: 2rem;">
        <!-- User added stories will appear here -->
      </div>
    </section>

    <!-- Add story section -->
    <section id="addStorySection" style="display:none;">
      <h1>Add a New Story</h1>
      <form id="storyForm">
        <label for="firstNameInput">First Name:</label>
        <input type="text" id="firstNameInput" name="firstName" placeholder="Enter your first name" required />

        <label for="lastNameInput">Last Name:</label>
        <input type="text" id="lastNameInput" name="lastName" placeholder="Enter your last name" required />

        <label for="titleInput">Story Title:</label>
        <input type="text" id="titleInput" name="title" placeholder="Enter story title" required />

        <label for="contentInput">Story Content:</label>
        <textarea id="contentInput" name="content" placeholder="Enter story content" required></textarea>

        <button type="submit" class="submit-btn">Add Story</button>
      </form>
    </section>
  </main>

  <footer>
    &copy; 2025 Corny Stories. All rights reserved.
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA11pEoYkNCIe6sQOMx15gt4YK7oJnGSis",
      authDomain: "corny-stories.firebaseapp.com",
      projectId: "corny-stories",
      storageBucket: "corny-stories.firebasestorage.app",
      messagingSenderId: "1048985672409",
      appId: "1:1048985672409:web:cc9460c35e68ab6f6ebcc8",
      measurementId: "G-FL9WHM0BVG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // UI elements
    const btnStory = document.getElementById('btnStory');
    const btnAddStory = document.getElementById('btnAddStory');
    const storySection = document.getElementById('storySection');
    const addStorySection = document.getElementById('addStorySection');
    const storyForm = document.getElementById('storyForm');
    const userStoriesContainer = document.getElementById('userStoriesContainer');

    // Switch tabs
    btnStory.addEventListener('click', () => {
      btnStory.classList.add('active');
      btnAddStory.classList.remove('active');
      storySection.style.display = 'block';
      addStorySection.style.display = 'none';
      loadUserStories();
    });

    btnAddStory.addEventListener('click', () => {
      btnAddStory.classList.add('active');
      btnStory.classList.remove('active');
      addStorySection.style.display = 'block';
      storySection.style.display = 'none';
    });

    // Load user stories from Firestore and display
    async function loadUserStories() {
      userStoriesContainer.innerHTML = '<p>Loading stories...</p>';
      try {
        const storiesCol = collection(db, 'stories');
        const q = query(storiesCol, orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          userStoriesContainer.innerHTML = '<p>No user stories added yet.</p>';
          return;
        }

        userStoriesContainer.innerHTML = '';
        querySnapshot.forEach(docSnap => {
          const story = docSnap.data();
          const id = docSnap.id;

          const storyDiv = document.createElement('div');
          storyDiv.classList.add('story-content');
          storyDiv.innerHTML = `
            <div class="author">Author: ${escapeHtml(story.firstName)} ${escapeHtml(story.lastName)}</div>
            <h3>${escapeHtml(story.title)}</h3>
            <p>${escapeHtml(story.content).replace(/\n/g, '<br>')}</p>
          `;

          // Add Delete button ONLY if author matches localStorage user
          const storedFirstName = localStorage.getItem('authorFirstName');
          const storedLastName = localStorage.getItem('authorLastName');
          if (storedFirstName === story.firstName && storedLastName === story.lastName) {
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', async () => {
              if (confirm('Are you sure you want to delete this story?')) {
                await deleteDoc(doc(db, 'stories', id));
                loadUserStories();
              }
            });
            storyDiv.appendChild(deleteBtn);
          }

          // Add audio button
          const audioBtn = document.createElement('button');
          audioBtn.classList.add('audio-btn');
          audioBtn.textContent = 'Listen';
          audioBtn.addEventListener('click', () => {
            speakText(`${story.title} by ${story.firstName} ${story.lastName}. ${story.content}`);
          });
          storyDiv.appendChild(audioBtn);

          userStoriesContainer.appendChild(storyDiv);
        });
      } catch (error) {
        userStoriesContainer.innerHTML = `<p>Error loading stories: ${error.message}</p>`;
      }
    }

    // Escape HTML to prevent injection
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Form submit handler
    storyForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const firstName = storyForm.firstName.value.trim();
      const lastName = storyForm.lastName.value.trim();
      const title = storyForm.title.value.trim();
      const content = storyForm.content.value.trim();

      if (!firstName || !lastName || !title || !content) {
        alert('Please fill in all fields.');
        return;
      }

      try {
        await addDoc(collection(db, 'stories'), {
          firstName,
          lastName,
          title,
          content,
          createdAt: new Date()
        });

        // Save author to localStorage for delete permission
        localStorage.setItem('authorFirstName', firstName);
        localStorage.setItem('authorLastName', lastName);

        alert('Story added successfully!');
        storyForm.reset();
        btnStory.click(); // switch to stories tab to see new story
      } catch (error) {
        alert('Error adding story: ' + error.message);
      }
    });

    // Text-to-speech for story content
    function speakText(text) {
      if (!window.speechSynthesis) {
        alert('Sorry, your browser does not support speech synthesis.');
        return;
      }
      const utterance = new SpeechSynthesisUtterance(text);
      speechSynthesis.cancel(); // stop previous speech if any
      speechSynthesis.speak(utterance);
    }

    // Load user stories on initial page load
    btnStory.click();
  </script>
</body>
</html>
